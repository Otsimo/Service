#!/usr/bin/env node
"use strict";
/**
 * Module dependencies.
 */

var db = require('../lib/db');
var config = require('config');
var cfenv = require("cfenv");

var appEnv = cfenv.getAppEnv();

console.log(appEnv.bind, appEnv.port);
console.log(appEnv.getServiceURL("mongodb0"));
var app, server;

function start() {
    return new Promise(function (resolve) {
        app = require('../lib/app');

        server = app.listen(appEnv.port, appEnv.bind, function () {
            console.log('Express server listening on port ' + server.address().port);
            resolve();
        });
    });

}

let dbopts = {
    url: appEnv.getServiceURL("mongodb0")
};

db.connect(dbopts)
    .then(db.init)
    .then(start)
    .then(function () {             // All gone well log it
        console.log('Server has started');
    })
    .catch(function (error) {       //Something went wrong log it
        console.log('initialize' + error.stack);
        throw error;
    });